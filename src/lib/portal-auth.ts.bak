import crypto from "crypto";
import { queries } from "./db";

/**
 * Generate or retrieve a magic link token for a parent account.
 * Token never expires (parent can always access via the same link).
 */
export function getOrCreatePortalToken(accountId: string): string {
  const existing = queries.getTokenByAccount.get(accountId) as any;
  if (existing) return existing.token;

  const token = crypto.randomBytes(24).toString("base64url");
  queries.createParentToken.run(token, accountId, null); // no expiry
  return token;
}

/**
 * Validate a portal token and return the account ID.
 */
export function validatePortalToken(token: string): string | null {
  const row = queries.getParentToken.get(token) as any;
  return row?.account_id || null;
}

/**
 * Build the portal URL for WhatsApp message.
 */
export function getPortalUrl(baseUrl: string, accountId: string): string {
  const token = getOrCreatePortalToken(accountId);
  return `${baseUrl}/portal/${token}`;
}
